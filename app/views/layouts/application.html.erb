<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for?(:title) ? yield(:title) : "Furima" %></title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <!-- 公開鍵メタは先に -->
    <meta name="payjp-public-key"
          content="<%= Rails.application.credentials.dig(:payjp, :public_key) || ENV['PAYJP_PUBLIC_KEY'] %>">

    <!-- PAY.JP SDK を先に読み込む -->
    <script src="https://js.pay.jp/v2/"></script>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>

    <!-- 最後に importmap（ここから application.js → payjp.js が実行される） -->
    <%= javascript_importmap_tags %>
  </head>

  <body>
    <% hide_global_header =
         content_for?(:no_global_header) ||
         (defined?(devise_controller?) && devise_controller? &&
            %w[sessions registrations passwords].include?(controller_name) &&
            %w[new create edit].include?(action_name))
    %>

    <%= render "shared/header" unless hide_global_header %>
    <%= yield %>
  </body>
</html>
